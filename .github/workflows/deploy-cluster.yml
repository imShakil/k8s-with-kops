name: Deploy Cluster

on:
  workflow_call:
    inputs:
      cluster_name:
        required: true
        type: string
      environment:
        required: true
        type: string
      available_zones:
        required: true
        type: string
      worker_nodes:
        required: false
        type: string
        default: '2'
      worker_size:
        required: false
        type: string
        default: 't2.small'
      master_size:
        required: false
        type: string
        default: 't2.medium'
      master_nodes:
        required: false
        type: string
        default: '1'
      event_name:
        required: true
        type: string

env:
  CLUSTER_NAME: ${{ inputs.cluster_name }}
  ENVIRONMENT: ${{ inputs.environment }}

jobs:
  deploy:
    name: Deploy kOps Cluster
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@651471c36a6092792c552e8b1bef71e592b462d8
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@56d6a583f00f6bad6d19d91d53a7bc3b8143d0e9
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install kOps and kubectl
        shell: bash
        run: |
          KOPS_VERSION=$(curl --proto =${PROTOCOL} -L -s ${PROTOCOL}://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)
          curl --proto =${PROTOCOL} -Lo kops "${PROTOCOL}://github.com/kubernetes/kops/releases/download/${KOPS_VERSION}/kops-linux-amd64"
          chmod +x kops && sudo mv kops /usr/local/bin/
          
          KUBECTL_VERSION=$(curl --proto =${PROTOCOL} -L -s ${PROTOCOL}://dl.k8s.io/release/stable.txt)
          curl --proto =${PROTOCOL} -LO "${PROTOCOL}://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          echo "âœ… Tools installed"
        env:
          PROTOCOL: "https"

      - name: SSH Key Setup
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -C "kops-${CLUSTER_NAME}"

      - name: Check Cluster Existence
        shell: bash
        run: |
          set -euo pipefail

          KOPS_STATE_STORE="s3://${{ vars.TF_STATE_BUCKET }}/${ENVIRONMENT}/clusters"
          echo "KOPS_STATE_STORE=${KOPS_STATE_STORE}" >> "$GITHUB_ENV"

          if kops get cluster \
            --name="${CLUSTER_NAME}" \
            --state="${KOPS_STATE_STORE}" >/dev/null 2>&1; then
            echo "CLUSTER_EXISTS=true" >> "$GITHUB_ENV"
          else
            echo "CLUSTER_EXISTS=false" >> "$GITHUB_ENV"
          fi

      - name: Create Cluster
        if: ${{ env.CLUSTER_EXISTS == 'false' }}
        shell: bash
        env:
          ZONES: ${{ inputs.available_zones }} 
          MASTER_NODES: ${{ inputs.master_nodes }} 
          WORKER_NODES: ${{ inputs.worker_nodes }} 
          MASTER_SIZE: ${{ inputs.master_size }} 
          WORKER_SIZE: ${{ inputs.worker_size }}
        run: |
          set -euo pipefail

          kops create cluster \
            --name="${CLUSTER_NAME}" \
            --state="${KOPS_STATE_STORE}" \
            --zones="$ZONES" \
            --node-count="$WORKER_NODES" \
            --node-size="$WORKER_SIZE" \
            --master-count="$MASTER_NODES" \
            --master-size="$MASTER_SIZE" \
            --networking=calico \
            --dns-zone="${CLUSTER_NAME}" \
            --ssh-public-key="$HOME/.ssh/id_rsa.pub"

      - name: Generate Terraform Files
        shell: bash
        run: |
          set -euo pipefail

          kops update cluster \
            --name="${CLUSTER_NAME}" \
            --state="${KOPS_STATE_STORE}" \
            --yes --admin \
            --out="./kops-infra" \
            --target=terraform

      - name: Deploy Infrastructure
        working-directory: ./kops-infra
        shell: bash
        run: |
          set -euo pipefail

          cat > backend.tf <<EOF
          terraform {
            backend "s3" {
              bucket = "${{ vars.TF_STATE_BUCKET }}"
              key    = "${ENVIRONMENT}/${CLUSTER_NAME}/kops.tfstate"
              region = "${{ vars.AWS_REGION }}"
            }
          }
          EOF

          terraform init -input=false
          terraform apply -auto-approve

      - name: Validate Cluster
        shell: bash
        run: |
          set -euo pipefail

          kops export kubeconfig \
            --name="${CLUSTER_NAME}" \
            --state="${KOPS_STATE_STORE}" \
            --admin

          kops validate cluster \
            --name="${CLUSTER_NAME}" \
            --state="${KOPS_STATE_STORE}" \
            --wait=10m

          kubectl get nodes

          aws s3 cp ~/.kube/config \
            "s3://${{ vars.TF_STATE_BUCKET }}/${ENVIRONMENT}/${CLUSTER_NAME}/kubeconfig"

          aws s3 cp ~/.ssh/id_rsa.pub \
            "s3://${{ vars.TF_STATE_BUCKET }}/${ENVIRONMENT}/${CLUSTER_NAME}/ssh-key.pub"
